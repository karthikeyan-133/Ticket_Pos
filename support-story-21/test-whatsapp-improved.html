<!DOCTYPE html>
<html>
<head>
    <title>Improved WhatsApp URL Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #128C7E;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Improved WhatsApp URL Test</h1>
    
    <div class="test-section">
        <h2>Test with Different Number Formats</h2>
        <label>Mobile Number: <input type="text" id="mobileNumber" value="0526075381" placeholder="Enter mobile number"></label>
        <label>Country Code: 
            <select id="countryCode">
                <option value="971">UAE (+971)</option>
                <option value="91">India (+91)</option>
                <option value="">None</option>
            </select>
        </label>
        <br>
        <label>Message: <input type="text" id="message" value="Hello, this is a test message from Techzon Support Team!" size="50"></label>
        <br>
        <button onclick="testWhatsApp()">Test WhatsApp Redirect</button>
    </div>
    
    <div class="test-section">
        <h2>Predefined Test Links</h2>
        <p>Click the links below to test the WhatsApp URL with the correct mobile number format:</p>
        
        <button onclick="openWhatsApp('api')">
            Open WhatsApp with pre-filled message (api.whatsapp.com)
        </button>
        
        <button onclick="openWhatsApp('wa')">
            Open WhatsApp with pre-filled message (wa.me)
        </button>
        
        <button onclick="openWhatsApp('web')">
            Open WhatsApp Web with pre-filled message (web.whatsapp.com)
        </button>
        
        <p>If the buttons above don't work, try this fallback:</p>
        <button onclick="openWhatsAppFallback()">Fallback WhatsApp Open</button>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <script>
        // Format mobile number based on country code
        function formatMobileNumber(number, countryCode) {
            // Remove all non-digit characters
            let cleanNumber = number.replace(/\D/g, '');
            
            // Apply formatting based on country code
            if (countryCode === '971') {
                // UAE formatting
                if (cleanNumber.startsWith('05') && cleanNumber.length === 10) {
                    // UAE format: 05XXXXXXXX -> 9715XXXXXXXX
                    return `971${cleanNumber.substring(1)}`;
                } else if (cleanNumber.length === 9 && cleanNumber.startsWith('5')) {
                    // UAE format: 5XXXXXXXX -> 9715XXXXXXXX
                    return `971${cleanNumber}`;
                } else if (cleanNumber.length === 10) {
                    // Other 10-digit formats: add 971 prefix
                    return `971${cleanNumber}`;
                }
            } else if (countryCode === '91') {
                // India formatting
                if (cleanNumber.startsWith('0') && cleanNumber.length === 11) {
                    // India format: 0XXXXXXXXXX -> 91XXXXXXXXXX
                    return `91${cleanNumber.substring(1)}`;
                } else if (cleanNumber.length === 10) {
                    // 10-digit India number: add 91 prefix
                    return `91${cleanNumber}`;
                }
            }
            
            // Use as-is for other formats
            return cleanNumber || number;
        }
        
        // Test WhatsApp with custom input
        function testWhatsApp() {
            const mobileNumber = document.getElementById('mobileNumber').value;
            const countryCode = document.getElementById('countryCode').value;
            const message = document.getElementById('message').value;
            
            const formattedNumber = formatMobileNumber(mobileNumber, countryCode);
            const encodedMessage = encodeURIComponent(message);
            
            // Try multiple URL schemes
            const urls = [
                `https://api.whatsapp.com/send?phone=${formattedNumber}&text=${encodedMessage}`,
                `https://wa.me/${formattedNumber}?text=${encodedMessage}`,
                `https://web.whatsapp.com/send?phone=${formattedNumber}&text=${encodedMessage}`
            ];
            
            // Display the URLs for testing
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h3>Generated URLs:</h3>
                <p>Formatted Number: ${formattedNumber}</p>
                <ul>
                    <li><a href="${urls[0]}" target="_blank">${urls[0]}</a></li>
                    <li><a href="${urls[1]}" target="_blank">${urls[1]}</a></li>
                    <li><a href="${urls[2]}" target="_blank">${urls[2]}</a></li>
                </ul>
            `;
            
            // Try to open WhatsApp
            openWhatsAppWithFallback(urls);
        }
        
        // Open WhatsApp with fallback mechanism
        function openWhatsAppWithFallback(urls) {
            let i = 0;
            const tryNextUrl = () => {
                if (i >= urls.length) {
                    // All URLs failed, show manual instructions
                    alert("Unable to open WhatsApp automatically. Please copy the URL and open it manually.");
                    return;
                }
                
                const newWindow = window.open(urls[i], '_blank');
                if (newWindow) {
                    // Success - WhatsApp opened
                    console.log("WhatsApp opened with URL:", urls[i]);
                } else {
                    // Failed, try next URL
                    i++;
                    setTimeout(tryNextUrl, 500); // Small delay before trying next
                }
            };
            
            tryNextUrl();
        }
        
        // Predefined test function
        function openWhatsApp(type) {
            const number = "971526075381";
            const message = "Hello Amal, Your support ticket TICKET/2025/4516 has been resolved. Resolution Details: This is a test resolution. Thank you for your patience! Techzon Support Team";
            const encodedMessage = encodeURIComponent(message);
            
            let url;
            switch(type) {
                case 'api':
                    url = `https://api.whatsapp.com/send?phone=${number}&text=${encodedMessage}`;
                    break;
                case 'wa':
                    url = `https://wa.me/${number}?text=${encodedMessage}`;
                    break;
                case 'web':
                    url = `https://web.whatsapp.com/send?phone=${number}&text=${encodedMessage}`;
                    break;
                default:
                    url = `https://api.whatsapp.com/send?phone=${number}&text=${encodedMessage}`;
            }
            
            const newWindow = window.open(url, '_blank');
            if (!newWindow) {
                // Fallback if popup blocked
                window.location.href = url;
            }
        }
        
        // Fallback function
        function openWhatsAppFallback() {
            const number = "971526075381";
            const message = "Hello Amal, Your support ticket TICKET/2025/4516 has been resolved. Resolution Details: This is a test resolution. Thank you for your patience! Techzon Support Team";
            const encodedMessage = encodeURIComponent(message);
            
            // Try multiple approaches
            const urls = [
                `https://api.whatsapp.com/send?phone=${number}&text=${encodedMessage}`,
                `https://wa.me/${number}?text=${encodedMessage}`,
                `https://web.whatsapp.com/send?phone=${number}&text=${encodedMessage}`
            ];
            
            openWhatsAppWithFallback(urls);
        }
    </script>
</body>
</html>